<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Wizard Game</title>
<!--    <link rel="stylesheet" href="/wizard/css/wizard.css">-->
    <script src="/js/ajax.js"></script>
    <style th:inline="text">
        [# th:each="card : ${cards}"]
        .[(${card.color})]-[(${card.sign})] {  background-image: url("/img/wizard/[(${card.color})]/[(${card.sign})].jpg"); }[/]
        .cover { background-image: url("/img/wizard/w-cover.jpg"); }
    </style>
    <style>
        .card-slot {
            background-color: #cccccc; /* Used if the image is unavailable */
            background-position: center; /* Center the image */
            background-repeat: no-repeat; /* Do not repeat the image */
            background-size: cover; /* Resize the background image to cover the entire container */
            width: 90px;
            height: 140px; /* You must set a specified height */
            float: left;
        }
        .hidden {
            /* as if the element was not there*/
            display: none;
        }
        .invisible {
            /* not visible but still part of the layout */
            visibility: hidden;
        }
        .empty {

        }
        .margin {
            margin-right: 3px;
            margin-bottom: 3px;
        }
    </style>
    <script th:inline="javascript">
        let players = [
            [# th:each="player : ${players}"]
            [[${player.id}]],
            [/]
        ];

        var interval;
        var myCards = [];
        var me; // userId
        var onTurn; // userId

        function cardToStyleClass(card) {
            var color = card.color.toLowerCase();

            var sign = card.value;
            if (card.value < 1)
                sign = "n";
            else if (card.value > 13)
                sign = "z";

            return color + "-" + sign;
        }

        // ajax: https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX/Getting_Started
        /**
         * Load the initial state of the game.
         */
        function onload() {
            ajax(onGetState, "GET", "/wizard/get-state");
        }

        function onGetState(response) {
            me = response.userId;
            onTurn = response.onTurn;

            document.getElementById("turn-" + onTurn).innerHTML = "&radic;";
            // todo: use different css style to highlight the "onTurn" player

            for (var i = 0; i < response.myCards.length; i++) {
                var card = response.myCards[i];
                var element = document.getElementById("slot-" + i);
                myCards.push(card);

                element.className = ""; // clear the list
                element.classList.add("card-slot", "margin", cardToStyleClass(card));
            }

            var trump = response.trump;
            var trumpElement = document.getElementById("trump-slot");
            trumpElement.className = ""; // clear the list
            if (trump === undefined) {
                trumpElement.classList.add("card-slot", "empty")
            } else {
                trumpElement.classList.add("card-slot", cardToStyleClass(trump))
            }

            for (var i = 0; i < response.actualCards.length; i++) {
                var actualCard = response.actualCards[i];
                var element = document.getElementById("played-" + actualCard.userId);
                element.classList.remove("cover");
                element.classList.add(cardToStyleClass(actualCard.card));
            }

            if (me !== onTurn) {
                // be notified about what other's are doing
                interval = setInterval(requestMessage, 1000);
            }
        }

        function onMyCard(index) {
            if (me === onTurn) {
                alert("card: " + cardToStyleClass(myCards[index]));

                // todo: call the server
            } else
                alert("Nejsi na tahu!")
        }

        /**
         * Check onTurn change - if there is a any, it means that the previous "onTurn" player has played a card
         * and we need
         * 1) show the played card
         * 2) change the actual player who is on turn to the new "onTurn" player
         */
        function requestMessage() {
            if (!onGetMessageReceived)
                return;

            onGetMessageReceived = false;
            ajax(onGetMessage, "GET", "/wizard/get-message")
        }

        // request overlap protection
        var onGetMessageReceived = true;
        function onGetMessage(response) {
            if (onTurn !== response.onTurn) {
                for (var i = 0; i < response.actualCards.length; i++) {
                    var actualCard = response.actualCards[i];
                    if (onTurn === actualCard.userId) {
                        var element = document.getElementById("played-" + actualCard.userId);
                        element.classList.remove("cover");
                        element.classList.add(cardToStyleClass(actualCard.card));
                    }
                }
                onTurn = response.onTurn;

                if (me === onTurn)
                    clearInterval(interval);
            }

            onGetMessageReceived = true;
        }
    </script>
</head>
<body onload="onload()">

<fieldset id="myCards">
    <legend>Moje karty v ruce</legend>
    <div th:each="slot, iter: ${slots}" th:id="'slot-' + ${slot}" class="card-slot hidden" th:data-index="${iter.index}" onclick="onMyCard(this.getAttribute('data-index'))"></div>
</fieldset>

<fieldset id="trump">
    <legend>Trumf</legend>
    <div id="trump-slot" class="card-slot"></div>
</fieldset>

<fieldset id="gameDesk">
    <legend>Hrací stůl</legend>
    <table width="1" border="1" >
        <tr>
            <th>Hráč</th>
            <th>Zahraná karta</th>
            <th>Počet vyhraných štychů</th>
            <th>Na tahu</th>
        </tr><tr th:each="player, stat: ${players}">
        <td th:text="${player.name}">Hráč 1</td>
        <td><div th:id="'played-' + ${player.id}" class="card-slot cover"></div></td>
        <td><div th:id="'win-' + ${player.id}"></div></td>
        <td><div th:id="'turn-' + ${player.id}"></div></td>
    </tr>
    </table>
</fieldset>

<fieldset id="score">
    <legend>Skóre</legend>
    <div>TODO</div>
</fieldset>

</body>
</html>
